<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Learning ESP-DL Series 02: Walkthrough on Training, Testing, and Deployment | Embedded Projects</title><meta name="author" content="tommok"><meta name="copyright" content="tommok"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="IntroductionIn the previous blog, we updated the example code to be compatible with a general ESP32-S3 dev kit module. One issue with the ESP-DL digit recognition example is that they do not provide t">
<meta property="og:type" content="article">
<meta property="og:title" content="Learning ESP-DL Series 02: Walkthrough on Training, Testing, and Deployment">
<meta property="og:url" content="https://tommokmok.github.io/2025/08/27/Learning-ESP-DL-Series-02-Walkthrough-on-training-test-deploy/index.html">
<meta property="og:site_name" content="Embedded Projects">
<meta property="og:description" content="IntroductionIn the previous blog, we updated the example code to be compatible with a general ESP32-S3 dev kit module. One issue with the ESP-DL digit recognition example is that they do not provide t">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://tommokmok.github.io/img/mcu.jpg">
<meta property="article:published_time" content="2025-08-27T00:48:57.000Z">
<meta property="article:modified_time" content="2025-09-02T04:50:57.880Z">
<meta property="article:author" content="tommok">
<meta property="article:tag" content="ESP32-S3">
<meta property="article:tag" content="ESP-DL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://tommokmok.github.io/img/mcu.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Learning ESP-DL Series 02: Walkthrough on Training, Testing, and Deployment",
  "url": "https://tommokmok.github.io/2025/08/27/Learning-ESP-DL-Series-02-Walkthrough-on-training-test-deploy/",
  "image": "https://tommokmok.github.io/img/mcu.jpg",
  "datePublished": "2025-08-27T00:48:57.000Z",
  "dateModified": "2025-09-02T04:50:57.880Z",
  "author": [
    {
      "@type": "Person",
      "name": "tommok",
      "url": "https://tommokmok.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/embedded_32_32.png"><link rel="canonical" href="https://tommokmok.github.io/2025/08/27/Learning-ESP-DL-Series-02-Walkthrough-on-training-test-deploy/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-7741480347149308',
  enable_page_level_ads: 'true'
});</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: 'Copy Successful',
    error: 'Copy Failed',
    noSupport: 'Browser Not Supported'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'Just now',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'Load More'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Learning ESP-DL Series 02: Walkthrough on Training, Testing, and Deployment',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/img/background.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">Embedded Projects</span></a><a class="nav-page-title" href="/"><span class="site-name">Learning ESP-DL Series 02: Walkthrough on Training, Testing, and Deployment</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  Back to Home</span></span></a></span><div id="menus"></div></nav><div id="post-info"><h1 class="post-title">Learning ESP-DL Series 02: Walkthrough on Training, Testing, and Deployment</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2025-08-27T00:48:57.000Z" title="Created 2025-08-27 08:48:57">2025-08-27</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2025-09-02T04:50:57.880Z" title="Updated 2025-09-02 12:50:57">2025-09-02</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Coding/">Coding</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post Views:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>In the previous blog, we updated the example code to be compatible with a general ESP32-S3 dev kit module.</p>
<p>One issue with the ESP-DL <code>digit recognition</code> example is that they do not provide the original PyTorch model or the output files generated after the <code>esp-ppq</code> process. Only the final <code>.espdl</code> file is provided.</p>
<p>Therefore, we need to build our own model based on their dataset.</p>
<p>Fortunately, Espressif provides the code for training, testing, and quantizing the model.</p>
<p>In this post, I will walk through the entire process: building the <code>.espdl</code> model using PyTorch and the <code>esp-ppq</code> library, and finally deploying it to the ESP32-S3 to verify it works.</p>
<h1 id="How-This-Blog-May-Help-You"><a href="#How-This-Blog-May-Help-You" class="headerlink" title="How This Blog May Help You"></a>How This Blog May Help You</h1><ul>
<li>Learn how to build a neural network using PyTorch.</li>
<li>Understand the complete workflow from dataset preparation to deployment on the ESP32-S3.</li>
</ul>
<span id="more"></span>

<h1 id="Prerequisites"><a href="#Prerequisites" class="headerlink" title="Prerequisites"></a>Prerequisites</h1><ul>
<li>Install the ESP-IDF according to the <a target="_blank" rel="noopener" href="https://github.com/espressif/vscode-esp-idf-extension/blob/master/README.md">official guide</a>.</li>
<li>Google Colab environment or similar for model training and quantization.</li>
</ul>
<h1 id="Development-Environment"><a href="#Development-Environment" class="headerlink" title="Development Environment"></a>Development Environment</h1><ul>
<li><strong>MCU:</strong> General ESP32-S3 dev kit (Waveshare ESP32-S3-DEV-Kit-N8R8)</li>
<li><strong>IDE:</strong> VS Code with ESP-IDF extension</li>
<li><strong>IDF version:</strong> v5.4.2</li>
<li><strong>ESP-DL version:</strong> v3.1.5</li>
<li><strong>touchpad-digit-recognition example code:</strong> <a target="_blank" rel="noopener" href="https://github.com/espressif/esp-iot-solution/tree/master/examples/ai/esp_dl/touchpad_digit_recognition">Commit id: 3e35842 date: Jun 9, 2025</a></li>
<li><strong>Python Version:</strong> v3.10.12 (Must use this version as <code>esp-ppq</code> does not support Python &gt;3.10)</li>
<li><strong>PyTorch Version:</strong> v2.8 Stable</li>
<li><strong>esp-dl package version:</strong> v1.0.1</li>
</ul>
<h1 id="Building-the-Model-Using-PyTorch-Step-by-Step"><a href="#Building-the-Model-Using-PyTorch-Step-by-Step" class="headerlink" title="Building the Model Using PyTorch: Step by Step"></a>Building the Model Using PyTorch: Step by Step</h1><p>To simplify the process, I recommend using Google Colab for model building.</p>
<p>Since the default Python version in Colab is v3.12, we will use <code>konda</code> to set up a virtual environment with Python 3.10 for <code>esp-ppq</code> compatibility.</p>
<p>Most of the code is adapted from the example, with added visualization functions to inspect the dataset.</p>
<h2 id="1-Install-konda-for-the-Virtual-Python-Environment"><a href="#1-Install-konda-for-the-Virtual-Python-Environment" class="headerlink" title="1. Install konda for the Virtual Python Environment"></a>1. Install <code>konda</code> for the Virtual Python Environment</h2><blockquote>
<p><code>konda</code> is a package that allows you to use <code>conda</code> in Colab. See <a target="_blank" rel="noopener" href="https://github.com/tamnguyenvan/konda">konda GitHub</a> for details.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">!pip install konda</span><br><span class="line"></span><br><span class="line">import konda</span><br><span class="line">konda.install()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check if conda is installed correctly</span></span><br><span class="line">!conda --version</span><br></pre></td></tr></table></figure>

<h2 id="2-Create-a-Python-3-10-Environment-Using-konda"><a href="#2-Create-a-Python-3-10-Environment-Using-konda" class="headerlink" title="2. Create a Python 3.10 Environment Using konda"></a>2. Create a Python 3.10 Environment Using <code>konda</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Accept the channels</span></span><br><span class="line">!conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main</span><br><span class="line">!conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create virtual environment</span></span><br><span class="line">!konda create -n esp_dl python=3.10 -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># Activate the environment</span></span><br><span class="line">!konda activate esp_dl</span><br><span class="line"></span><br><span class="line"><span class="comment"># Check Python version</span></span><br><span class="line">!konda run <span class="string">&quot;python --version&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Install dependencies</span></span><br><span class="line">!konda run <span class="string">&quot;pip3 install torch torchvision esp-ppq&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Check torch and esp-ppq versions</span></span><br><span class="line">!konda run <span class="string">&quot;pip list&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>Note:</strong> The package name for import is <code>esp_ppq</code>, not <code>esp-ppq</code>.</p>
</blockquote>
<blockquote>
<p><strong>Note:</strong> Installing torch and esp-ppq may take some time.</p>
</blockquote>
<h2 id="3-Download-the-Dataset"><a href="#3-Download-the-Dataset" class="headerlink" title="3. Download the Dataset"></a>3. Download the Dataset</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">from</span> pathlib <span class="keyword">import</span> Path</span><br><span class="line"></span><br><span class="line">data_path = Path(<span class="string">&quot;/data/&quot;</span>)</span><br><span class="line">image_path = data_path / <span class="string">&quot;dataset&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> image_path.is_dir():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;image_path&#125;</span> directory exists.&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Did not find <span class="subst">&#123;image_path&#125;</span> directory, creating one...&quot;</span>)</span><br><span class="line">    image_path.mkdir(parents=<span class="literal">True</span>, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Download data</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(data_path / <span class="string">&quot;dataset.zip&quot;</span>, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        request = requests.get(<span class="string">&quot;https://dl.espressif.com/AE/esp-iot-solution/touch_dataset.zip&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Downloading data...&quot;</span>)</span><br><span class="line">        f.write(request.content)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Unzip data</span></span><br><span class="line">    <span class="keyword">with</span> zipfile.ZipFile(data_path / <span class="string">&quot;dataset.zip&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> zip_ref:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Unzipping data...&quot;</span>)</span><br><span class="line">        zip_ref.extractall(image_path)</span><br></pre></td></tr></table></figure>

<h2 id="4-Prepare-the-Dataset"><a href="#4-Prepare-the-Dataset" class="headerlink" title="4. Prepare the Dataset"></a>4. Prepare the Dataset</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"><span class="keyword">import</span> torch.optim <span class="keyword">as</span> optim</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> DataLoader, random_split</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> datasets, transforms</span><br><span class="line"></span><br><span class="line">transform = transforms.Compose([</span><br><span class="line">    transforms.Grayscale(num_output_channels=<span class="number">1</span>),</span><br><span class="line">    transforms.RandomAffine(degrees=<span class="number">10</span>, translate=(<span class="number">0.1</span>, <span class="number">0.1</span>)),</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    transforms.Normalize((<span class="number">0.5</span>,), (<span class="number">0.5</span>,)),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">dataset = datasets.ImageFolder(root=<span class="string">&#x27;/data/dataset/touch_dataset&#x27;</span>, transform=transform)</span><br><span class="line"></span><br><span class="line">train_size = <span class="built_in">int</span>(<span class="number">0.8</span> * <span class="built_in">len</span>(dataset))</span><br><span class="line">test_size = <span class="built_in">len</span>(dataset) - train_size</span><br><span class="line">train_dataset, test_dataset = random_split(dataset, [train_size, test_size])</span><br><span class="line"></span><br><span class="line">train_loader = DataLoader(dataset=train_dataset, batch_size=<span class="number">32</span>, shuffle=<span class="literal">True</span>)</span><br><span class="line">test_loader = DataLoader(dataset=test_dataset, batch_size=<span class="number">32</span>, shuffle=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>

<h2 id="5-Visualize-the-Dataset"><a href="#5-Visualize-the-Dataset" class="headerlink" title="5. Visualize the Dataset"></a>5. Visualize the Dataset</h2><p>Function to check random images from the dataset:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">display_random_images</span>(<span class="params">dataset: torch.utils.data.dataset.Dataset,</span></span><br><span class="line"><span class="params">                          classes: <span class="built_in">list</span>[<span class="built_in">str</span>] = <span class="literal">None</span>,</span></span><br><span class="line"><span class="params">                          n: <span class="built_in">int</span> = <span class="number">10</span>,</span></span><br><span class="line"><span class="params">                          display_shape: <span class="built_in">bool</span> = <span class="literal">True</span>,</span></span><br><span class="line"><span class="params">                          seed: <span class="built_in">int</span> = <span class="literal">None</span></span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> n &gt; <span class="number">10</span>:</span><br><span class="line">        n = <span class="number">10</span></span><br><span class="line">        display_shape = <span class="literal">False</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;For display purposes, n shouldn&#x27;t be larger than 10, setting to 10 and removing shape display.&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 3. Set random seed</span></span><br><span class="line">    <span class="keyword">if</span> seed:</span><br><span class="line">        random.seed(seed)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 4. Get random sample indexes</span></span><br><span class="line">    random_samples_idx = random.sample(<span class="built_in">range</span>(<span class="built_in">len</span>(dataset)), k=n)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 5. Setup plot</span></span><br><span class="line">    plt.figure(figsize=(<span class="number">16</span>, <span class="number">8</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 6. Loop through samples and display random samples</span></span><br><span class="line">    <span class="keyword">for</span> i, targ_sample <span class="keyword">in</span> <span class="built_in">enumerate</span>(random_samples_idx):</span><br><span class="line">        targ_image, targ_label = dataset[targ_sample][<span class="number">0</span>], dataset[targ_sample][<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 7. Adjust image tensor shape for plotting: [color_channels, height, width] -&gt; [color_channels, height, width]</span></span><br><span class="line">        targ_image_adjust = targ_image.permute(<span class="number">1</span>, <span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Plot adjusted samples</span></span><br><span class="line">        plt.subplot(<span class="number">1</span>, n, i+<span class="number">1</span>)</span><br><span class="line">        plt.imshow(targ_image_adjust)</span><br><span class="line">        plt.axis(<span class="string">&quot;off&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> classes:</span><br><span class="line">            title = <span class="string">f&quot;class: <span class="subst">&#123;classes[targ_label]&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">if</span> display_shape:</span><br><span class="line">                title = title + <span class="string">f&quot;\nshape: <span class="subst">&#123;targ_image_adjust.shape&#125;</span>&quot;</span></span><br><span class="line">        plt.title(title)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Display random images from ImageFolder created Dataset</span></span><br><span class="line">display_random_images(train_dataset,</span><br><span class="line">                      n=<span class="number">5</span>,</span><br><span class="line">                      classes=class_names,</span><br><span class="line">                      seed=<span class="number">42</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://ibb.co/MHYVKcf"><img src="https://i.ibb.co/MHYVKcf/check-dataset.png" alt="check-dataset" border="0"></a></p>
<h2 id="6-Define-Loss-Function-and-Optimizer"><a href="#6-Define-Loss-Function-and-Optimizer" class="headerlink" title="6. Define Loss Function and Optimizer"></a>6. Define Loss Function and Optimizer</h2><p>Use standard loss and optimizer for image classification:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">device = <span class="string">&quot;cuda:0&quot;</span> <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> <span class="string">&quot;cpu&quot;</span></span><br><span class="line">model = Net().to(device)</span><br><span class="line">criterion = nn.CrossEntropyLoss()</span><br><span class="line">optimizer = optim.Adam(model.parameters(), lr=<span class="number">0.001</span>)</span><br></pre></td></tr></table></figure>

<h2 id="7-Training-Process"><a href="#7-Training-Process" class="headerlink" title="7. Training Process"></a>7. Training Process</h2><p>Set <code>num_epochs</code> to 50 for faster training.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_epoch</span>(<span class="params">model, train_loader, criterion, optimizer, device</span>):</span><br><span class="line">    model.train()</span><br><span class="line">    running_loss = <span class="number">0.0</span></span><br><span class="line">    correct = <span class="number">0</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> inputs, labels <span class="keyword">in</span> train_loader:</span><br><span class="line">        inputs, labels = inputs.to(device), labels.to(device)</span><br><span class="line">        optimizer.zero_grad()</span><br><span class="line">        outputs = model(inputs)</span><br><span class="line">        loss = criterion(outputs, labels)</span><br><span class="line">        loss.backward()</span><br><span class="line">        optimizer.step()</span><br><span class="line"></span><br><span class="line">        running_loss += loss.item()</span><br><span class="line">        _, predicted = torch.<span class="built_in">max</span>(outputs.data, <span class="number">1</span>)</span><br><span class="line">        total += labels.size(<span class="number">0</span>)</span><br><span class="line">        correct += (predicted == labels).<span class="built_in">sum</span>().item()</span><br><span class="line"></span><br><span class="line">    epoch_loss = running_loss / <span class="built_in">len</span>(train_loader)</span><br><span class="line">    epoch_acc = <span class="number">100</span> * correct / total</span><br><span class="line">    <span class="keyword">return</span> epoch_loss, epoch_acc</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_epoch</span>(<span class="params">model, test_loader, criterion, device</span>):</span><br><span class="line">    model.<span class="built_in">eval</span>()</span><br><span class="line">    running_loss = <span class="number">0.0</span></span><br><span class="line">    correct = <span class="number">0</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">        <span class="keyword">for</span> inputs, labels <span class="keyword">in</span> test_loader:</span><br><span class="line">            inputs, labels = inputs.to(device), labels.to(device)</span><br><span class="line">            outputs = model(inputs)</span><br><span class="line">            loss = criterion(outputs, labels)</span><br><span class="line">            running_loss += loss.item()</span><br><span class="line">            _, predicted = torch.<span class="built_in">max</span>(outputs.data, <span class="number">1</span>)</span><br><span class="line">            total += labels.size(<span class="number">0</span>)</span><br><span class="line">            correct += (predicted == labels).<span class="built_in">sum</span>().item()</span><br><span class="line"></span><br><span class="line">    epoch_loss = running_loss / <span class="built_in">len</span>(test_loader)</span><br><span class="line">    epoch_acc = <span class="number">100</span> * correct / total</span><br><span class="line">    <span class="keyword">return</span> epoch_loss, epoch_acc</span><br><span class="line"></span><br><span class="line">num_epochs = <span class="number">50</span></span><br><span class="line">train_acc_array = []</span><br><span class="line">test_acc_array = []</span><br><span class="line"><span class="keyword">for</span> epoch <span class="keyword">in</span> <span class="built_in">range</span>(num_epochs):</span><br><span class="line">    train_loss, train_acc = train_epoch(model, train_loader, criterion, optimizer, device)</span><br><span class="line">    test_loss, test_acc = test_epoch(model, test_loader, criterion, device)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Epoch [<span class="subst">&#123;epoch + <span class="number">1</span>&#125;</span>/<span class="subst">&#123;num_epochs&#125;</span>], &#x27;</span></span><br><span class="line">        <span class="string">f&#x27;Train Loss: <span class="subst">&#123;train_loss:<span class="number">.4</span>f&#125;</span>, Train Acc: <span class="subst">&#123;train_acc:<span class="number">.2</span>f&#125;</span>%, &#x27;</span></span><br><span class="line">        <span class="string">f&#x27;Test Loss: <span class="subst">&#123;test_loss:<span class="number">.4</span>f&#125;</span>, Test Acc: <span class="subst">&#123;test_acc:<span class="number">.2</span>f&#125;</span>%&#x27;</span>)</span><br><span class="line">    train_acc_array.append(train_acc)</span><br><span class="line">    test_acc_array.append(test_acc)</span><br><span class="line"></span><br><span class="line">torch.save(model.state_dict(), <span class="string">&#x27;/content/my_final_model.pth&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://ibb.co/DDrVTK9b"><img src="https://i.ibb.co/DDrVTK9b/training.png" alt="training" border="0"></a></p>
<p>Now you have a trained PyTorch model.</p>
<h2 id="8-Quantize-the-Model-Using-esp-ppq"><a href="#8-Quantize-the-Model-Using-esp-ppq" class="headerlink" title="8. Quantize the Model Using esp-ppq"></a>8. Quantize the Model Using <code>esp-ppq</code></h2><p>Since we are using <code>konda</code>, the quantization script should be saved to a file. Use <code>%%writefile</code> in Colab.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">%%writefile espdl_model_quant.py</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">from</span> esp_ppq.api <span class="keyword">import</span> espdl_quantize_torch</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> Dataset</span><br><span class="line"><span class="keyword">from</span> torch.utils.data <span class="keyword">import</span> random_split</span><br><span class="line"><span class="keyword">from</span> torchvision <span class="keyword">import</span> transforms, datasets</span><br><span class="line">BATCH_SIZE = <span class="number">32</span></span><br><span class="line">INPUT_SHAPE = [<span class="number">1</span>, <span class="number">25</span>, <span class="number">30</span>]</span><br><span class="line">TARGET = <span class="string">&quot;esp32s3&quot;</span></span><br><span class="line">NUM_OF_BITS = <span class="number">8</span></span><br><span class="line">ESPDL_MODEL_PATH = <span class="string">&quot;./my_final_model.espdl&quot;</span></span><br><span class="line">DEVICE = <span class="string">&quot;cpu&quot;</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Net</span>(torch.nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">super</span>(Net, <span class="variable language_">self</span>).__init__()</span><br><span class="line">        <span class="variable language_">self</span>.model = torch.nn.Sequential(</span><br><span class="line">            torch.nn.Conv2d(in_channels=<span class="number">1</span>, out_channels=<span class="number">16</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>),</span><br><span class="line">            torch.nn.ReLU(),</span><br><span class="line">            torch.nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            torch.nn.Conv2d(in_channels=<span class="number">16</span>, out_channels=<span class="number">32</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>),</span><br><span class="line">            torch.nn.ReLU(),</span><br><span class="line">            torch.nn.MaxPool2d(kernel_size=<span class="number">2</span>, stride=<span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">            torch.nn.Conv2d(in_channels=<span class="number">32</span>, out_channels=<span class="number">64</span>, kernel_size=<span class="number">3</span>, stride=<span class="number">1</span>, padding=<span class="number">1</span>),</span><br><span class="line">            torch.nn.ReLU(),</span><br><span class="line"></span><br><span class="line">            torch.nn.Flatten(),</span><br><span class="line">            torch.nn.Linear(in_features=<span class="number">7</span> * <span class="number">6</span> * <span class="number">64</span>, out_features=<span class="number">256</span>),</span><br><span class="line">            torch.nn.ReLU(),</span><br><span class="line">            torch.nn.Dropout(p=<span class="number">0.5</span>),</span><br><span class="line">            torch.nn.Linear(in_features=<span class="number">256</span>, out_features=<span class="number">10</span>),</span><br><span class="line">            torch.nn.Softmax(dim=<span class="number">1</span>)</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        output = <span class="variable language_">self</span>.model(x)</span><br><span class="line">        <span class="keyword">return</span> output</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeatureOnlyDataset</span>(<span class="title class_ inherited__">Dataset</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, original_dataset</span>):</span><br><span class="line">        <span class="variable language_">self</span>.features = []</span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> original_dataset:</span><br><span class="line">            <span class="variable language_">self</span>.features.append(item[<span class="number">0</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(<span class="variable language_">self</span>.features)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, idx</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">self</span>.features[idx]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">collate_fn2</span>(<span class="params">batch</span>):</span><br><span class="line">    features = torch.stack(batch)</span><br><span class="line">    <span class="keyword">return</span> features.to(DEVICE)</span><br><span class="line"></span><br><span class="line">transform = transforms.Compose([</span><br><span class="line">    transforms.Grayscale(num_output_channels=<span class="number">1</span>),</span><br><span class="line">    transforms.ToTensor(),</span><br><span class="line">    transforms.Normalize((<span class="number">0.5</span>,), (<span class="number">0.5</span>,)),</span><br><span class="line">])</span><br><span class="line"></span><br><span class="line">dataset = datasets.ImageFolder(root=<span class="string">&#x27;/data/dataset/touch_dataset&#x27;</span>, transform=transform)</span><br><span class="line">train_size = <span class="built_in">int</span>(<span class="number">0.8</span> * <span class="built_in">len</span>(dataset))</span><br><span class="line">test_size = <span class="built_in">len</span>(dataset) - train_size</span><br><span class="line">train_dataset, test_dataset = random_split(dataset, [train_size, test_size])</span><br><span class="line"></span><br><span class="line">image = Image.<span class="built_in">open</span>(<span class="string">&quot;/data/dataset/touch_dataset/9/20250225_140331.png&quot;</span>).convert(<span class="string">&#x27;L&#x27;</span>)</span><br><span class="line">input_tensor = transform(image).unsqueeze(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">feature_only_test_data = FeatureOnlyDataset(test_dataset)</span><br><span class="line"></span><br><span class="line">testDataLoader = torch.utils.data.DataLoader(dataset=feature_only_test_data, batch_size=<span class="number">32</span>, shuffle=<span class="literal">False</span>,</span><br><span class="line">                                            collate_fn=collate_fn2)</span><br><span class="line"></span><br><span class="line">model = Net().to(DEVICE)</span><br><span class="line">model.load_state_dict(torch.load(<span class="string">&quot;/content/my_final_model.pth&quot;</span>, map_location=DEVICE))</span><br><span class="line">model.<span class="built_in">eval</span>()</span><br><span class="line"></span><br><span class="line">quant_ppq_graph = espdl_quantize_torch(</span><br><span class="line">    model=model,</span><br><span class="line">    espdl_export_file=ESPDL_MODEL_PATH,</span><br><span class="line">    calib_dataloader=testDataLoader,</span><br><span class="line">    calib_steps=<span class="number">8</span>,</span><br><span class="line">    input_shape=[<span class="number">1</span>] + INPUT_SHAPE,</span><br><span class="line">    inputs=[input_tensor],</span><br><span class="line">    target=TARGET,</span><br><span class="line">    num_of_bits=NUM_OF_BITS,</span><br><span class="line">    device=DEVICE,</span><br><span class="line">    error_report=<span class="literal">True</span>,</span><br><span class="line">    skip_export=<span class="literal">False</span>,</span><br><span class="line">    export_test_values=<span class="literal">True</span>,</span><br><span class="line">    verbose=<span class="number">1</span>,</span><br><span class="line">    dispatching_override=<span class="literal">None</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h2 id="9-Run-the-Quantization-Script-in-the-Python-3-10-Environment"><a href="#9-Run-the-Quantization-Script-in-the-Python-3-10-Environment" class="headerlink" title="9. Run the Quantization Script in the Python 3.10 Environment"></a>9. Run the Quantization Script in the Python 3.10 Environment</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">!konda run <span class="string">&quot;python espdl_model_quant.py&quot;</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://ibb.co/jvNjMJh7"><img src="https://i.ibb.co/jvNjMJh7/quantization-finished.png" alt="quantization-finished" border="0"></a></p>
<h2 id="10-After-Quantization"><a href="#10-After-Quantization" class="headerlink" title="10. After Quantization"></a>10. After Quantization</h2><p>You will get the <code>.onnx</code> model, which you can inspect using Netron.</p>
<p><a target="_blank" rel="noopener" href="https://ibb.co/Jhv2pYc"><img src="https://i.ibb.co/Jhv2pYc/onnx-viewer.png" alt="onnx-viewer" border="0"></a></p>
<h2 id="11-Copy-the-espdl-File-to-the-ESP32-S3-Working-Directory"><a href="#11-Copy-the-espdl-File-to-the-ESP32-S3-Working-Directory" class="headerlink" title="11. Copy the .espdl File to the ESP32-S3 Working Directory"></a>11. Copy the <code>.espdl</code> File to the ESP32-S3 Working Directory</h2><p><a target="_blank" rel="noopener" href="https://ibb.co/9Sdpm5j"><img src="https://i.ibb.co/9Sdpm5j/copy-espdl.png" alt="copy-espdl" border="0"></a></p>
<h2 id="12-Update-CMakeLists-txt-to-Use-the-New-Model"><a href="#12-Update-CMakeLists-txt-to-Use-the-New-Model" class="headerlink" title="12. Update CMakeLists.txt to Use the New Model"></a>12. Update <code>CMakeLists.txt</code> to Use the New Model</h2><p><a target="_blank" rel="noopener" href="https://ibb.co/G4SL1QsP"><img src="https://i.ibb.co/G4SL1QsP/update-cmake-list.png" alt="update-cmake-list" border="0"></a></p>
<h2 id="13-Build-and-Flash-the-Firmware-Using-Your-Own-Model"><a href="#13-Build-and-Flash-the-Firmware-Using-Your-Own-Model" class="headerlink" title="13. Build and Flash the Firmware Using Your Own Model"></a>13. Build and Flash the Firmware Using Your Own Model</h2><h2 id="14-Success"><a href="#14-Success" class="headerlink" title="14. Success!"></a>14. Success!</h2><p><a target="_blank" rel="noopener" href="https://ibb.co/d4j50MN9"><img src="https://i.ibb.co/d4j50MN9/seems-works.png" alt="seems-works" border="0"></a></p>
<h1 id="Issue-Summary"><a href="#Issue-Summary" class="headerlink" title="Issue Summary"></a>Issue Summary</h1><ul>
<li>As of this writing, the <code>esp-dl</code> package requires Python version &lt;&#x3D;3.10. It does not work with Python &gt;3.12.</li>
<li>When importing the package, use <code>esp_ppq</code> (with an underscore), not <code>esp-ppq</code>.</li>
<li>Most of the time was spent figuring out how to change the Python version in Google Colab. Using <code>konda</code> to create a virtual environment solved this issue.</li>
</ul>
<hr>
<p><em>In the next post in this series, I will review the model and highlight all the important points about the neural network architecture used in digit recognition.</em></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>Author: </span><span class="post-copyright-info"><a href="https://tommokmok.github.io">tommok</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>Link: </span><span class="post-copyright-info"><a href="https://tommokmok.github.io/2025/08/27/Learning-ESP-DL-Series-02-Walkthrough-on-training-test-deploy/">https://tommokmok.github.io/2025/08/27/Learning-ESP-DL-Series-02-Walkthrough-on-training-test-deploy/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>Copyright Notice: </span><span class="post-copyright-info">All articles on this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless otherwise stated.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ESP32-S3/">ESP32-S3</a><a class="post-meta__tags" href="/tags/ESP-DL/">ESP-DL</a></div><div class="post-share"><div class="social-share" data-image="/img/mcu.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/08/27/Learning-ESP-DL-Series-03-Neural-Network-Architecture/" title="Learning ESP-DL Series 03: Neural Network Architecture"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">Previous</div><div class="info-item-2">Learning ESP-DL Series 03: Neural Network Architecture</div></div><div class="info-2"><div class="info-item-1">IntroductionIn the previous blog, we walked through how to prepare the dataset, train, quantize, and deploy the model to the ESP32-S3, following the ESP-DL digit recognition example code:https://github.com/espressif/esp-iot-solution/tree/master/examples/ai/esp_dl/touchpad_digit_recognition However, we did not take a closer look at how the neural network itself is designed. In this post, I will explain the details of the neural network architecture based on my understanding. Later on, I plan t...</div></div></div></a><a class="pagination-related" href="/2025/08/18/Learning-ESP-DL-Series-01-Digi-Recognition/" title="Learning ESP-DL Series 01: Digit Recognition"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">Next</div><div class="info-item-2">Learning ESP-DL Series 01: Digit Recognition</div></div><div class="info-2"><div class="info-item-1">IntroductionIn the previous blog, we verified the hardware and development environment. This time, we will go through another interesting example: touchpad-digit-recognition. This is an ESP AI example that demonstrates the complete deep learning development workflow, from data collection and training to device deployment. In this blog, I will clone this example and run the code on my own hardware, which does not have a touch sensor. How This Blog May Help You Learn ESP-DL in detail. If you wa...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/08/15/Learning-ESP-DL-Series-00-First-Impression/" title="Learning ESP-DL Series 2025 - 00: First Impression"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-15</div><div class="info-item-2">Learning ESP-DL Series 2025 - 00: First Impression</div></div><div class="info-2"><div class="info-item-1">IntroductionThis is the first post in a series of blogs that will explore the ESP-DL library in detail. At the time of writing, there is very little information or tutorials available for ESP-DL, especially practical guides on how to use it effectively. The official documentation from Espressif only explains what the library is, but does not clarify why you might need it, how to use it correctly, or provide helpful tips. In this post, I will focus on running an example code from the ESP-DL li...</div></div></div></a><a class="pagination-related" href="/2025/08/18/Learning-ESP-DL-Series-01-Digi-Recognition/" title="Learning ESP-DL Series 01: Digit Recognition"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-18</div><div class="info-item-2">Learning ESP-DL Series 01: Digit Recognition</div></div><div class="info-2"><div class="info-item-1">IntroductionIn the previous blog, we verified the hardware and development environment. This time, we will go through another interesting example: touchpad-digit-recognition. This is an ESP AI example that demonstrates the complete deep learning development workflow, from data collection and training to device deployment. In this blog, I will clone this example and run the code on my own hardware, which does not have a touch sensor. How This Blog May Help You Learn ESP-DL in detail. If you wa...</div></div></div></a><a class="pagination-related" href="/2025/07/16/ESP32-S3-lvgl-YetAnotherSketchpad/" title="ESP32-S3 lvgl: YetAnotherSketchpad 2025"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-07-16</div><div class="info-item-2">ESP32-S3 lvgl: YetAnotherSketchpad 2025</div></div><div class="info-2"><div class="info-item-1">ESP32-S3 Yet Another SketchpadA demo project for ESP32-S3 using LVGL to implement a sketchpad on a 320 x 240 TFT display. This is a sibling project to YetAnotherStockPriceTracker and uses the same hardware. Almost 90% of the code is referenced from lv_100ask_sketchpad, but updated for LVGL v9.2.2 and fixed for compatibility with ESP32-S3. Project Core Values For learning purposes. The implementation is kept simple and straightforward. No fancy stuff,  make it work.  How This Project May Help ...</div></div></div></a><a class="pagination-related" href="/2025/08/27/Learning-ESP-DL-Series-03-Neural-Network-Architecture/" title="Learning ESP-DL Series 03: Neural Network Architecture"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-27</div><div class="info-item-2">Learning ESP-DL Series 03: Neural Network Architecture</div></div><div class="info-2"><div class="info-item-1">IntroductionIn the previous blog, we walked through how to prepare the dataset, train, quantize, and deploy the model to the ESP32-S3, following the ESP-DL digit recognition example code:https://github.com/espressif/esp-iot-solution/tree/master/examples/ai/esp_dl/touchpad_digit_recognition However, we did not take a closer look at how the neural network itself is designed. In this post, I will explain the details of the neural network architecture based on my understanding. Later on, I plan t...</div></div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/mcu.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">tommok</div><div class="author-info-description">Small project, small step to success</div><div class="site-data"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">10</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">7</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">4</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/tommokmok"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">Get busy living or get busy dying. -- Stephen King</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Contents</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Introduction"><span class="toc-number">1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#How-This-Blog-May-Help-You"><span class="toc-number">2.</span> <span class="toc-text">How This Blog May Help You</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Prerequisites"><span class="toc-number">3.</span> <span class="toc-text">Prerequisites</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Development-Environment"><span class="toc-number">4.</span> <span class="toc-text">Development Environment</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Building-the-Model-Using-PyTorch-Step-by-Step"><span class="toc-number">5.</span> <span class="toc-text">Building the Model Using PyTorch: Step by Step</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Install-konda-for-the-Virtual-Python-Environment"><span class="toc-number">5.1.</span> <span class="toc-text">1. Install konda for the Virtual Python Environment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Create-a-Python-3-10-Environment-Using-konda"><span class="toc-number">5.2.</span> <span class="toc-text">2. Create a Python 3.10 Environment Using konda</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Download-the-Dataset"><span class="toc-number">5.3.</span> <span class="toc-text">3. Download the Dataset</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Prepare-the-Dataset"><span class="toc-number">5.4.</span> <span class="toc-text">4. Prepare the Dataset</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-Visualize-the-Dataset"><span class="toc-number">5.5.</span> <span class="toc-text">5. Visualize the Dataset</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Define-Loss-Function-and-Optimizer"><span class="toc-number">5.6.</span> <span class="toc-text">6. Define Loss Function and Optimizer</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-Training-Process"><span class="toc-number">5.7.</span> <span class="toc-text">7. Training Process</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Quantize-the-Model-Using-esp-ppq"><span class="toc-number">5.8.</span> <span class="toc-text">8. Quantize the Model Using esp-ppq</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-Run-the-Quantization-Script-in-the-Python-3-10-Environment"><span class="toc-number">5.9.</span> <span class="toc-text">9. Run the Quantization Script in the Python 3.10 Environment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-After-Quantization"><span class="toc-number">5.10.</span> <span class="toc-text">10. After Quantization</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#11-Copy-the-espdl-File-to-the-ESP32-S3-Working-Directory"><span class="toc-number">5.11.</span> <span class="toc-text">11. Copy the .espdl File to the ESP32-S3 Working Directory</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#12-Update-CMakeLists-txt-to-Use-the-New-Model"><span class="toc-number">5.12.</span> <span class="toc-text">12. Update CMakeLists.txt to Use the New Model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#13-Build-and-Flash-the-Firmware-Using-Your-Own-Model"><span class="toc-number">5.13.</span> <span class="toc-text">13. Build and Flash the Firmware Using Your Own Model</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#14-Success"><span class="toc-number">5.14.</span> <span class="toc-text">14. Success!</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Issue-Summary"><span class="toc-number">6.</span> <span class="toc-text">Issue Summary</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Posts</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/27/Learning-ESP-DL-Series-03-Neural-Network-Architecture/" title="Learning ESP-DL Series 03: Neural Network Architecture">Learning ESP-DL Series 03: Neural Network Architecture</a><time datetime="2025-08-27T07:58:43.000Z" title="Created 2025-08-27 15:58:43">2025-08-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/27/Learning-ESP-DL-Series-02-Walkthrough-on-training-test-deploy/" title="Learning ESP-DL Series 02: Walkthrough on Training, Testing, and Deployment">Learning ESP-DL Series 02: Walkthrough on Training, Testing, and Deployment</a><time datetime="2025-08-27T00:48:57.000Z" title="Created 2025-08-27 08:48:57">2025-08-27</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/18/Learning-ESP-DL-Series-01-Digi-Recognition/" title="Learning ESP-DL Series 01: Digit Recognition">Learning ESP-DL Series 01: Digit Recognition</a><time datetime="2025-08-18T02:06:03.000Z" title="Created 2025-08-18 10:06:03">2025-08-18</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/08/15/Learning-ESP-DL-Series-00-First-Impression/" title="Learning ESP-DL Series 2025 - 00: First Impression">Learning ESP-DL Series 2025 - 00: First Impression</a><time datetime="2025-08-15T05:30:25.000Z" title="Created 2025-08-15 13:30:25">2025-08-15</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2025/07/29/Learning-Pytorch-in-2025/" title="Learning ESP32-DL library &amp; Pytorch in 2025">Learning ESP32-DL library &amp; Pytorch in 2025</a><time datetime="2025-07-29T02:16:32.000Z" title="Created 2025-07-29 10:16:32">2025-07-29</time></div></div></div></div></div></div></main><footer id="footer"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;&nbsp;2025 By tommok</span><span class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.3</a></span></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Reading Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Toggle Between Light and Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle Between Single-column and Double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="Settings"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back to Top"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>